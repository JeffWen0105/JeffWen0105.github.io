<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Ansible - 變數管理及應用 - HowHow の WebSite</title><meta name="Description" content=""><meta property="og:title" content="Ansible - 變數管理及應用" />
<meta property="og:description" content="透過 Playbook 可以很方便執行大量機器部署，在大量環境下可以透過變數方式，如同寫程式一般可以更靈活且彈性的進行部署及維護。 練習環境 可以使用 HowHow 的創建 Lab 練" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.howhow.tk/posts/ansible/2022/ansible-variables/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-04-01T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ansible - 變數管理及應用"/>
<meta name="twitter:description" content="透過 Playbook 可以很方便執行大量機器部署，在大量環境下可以透過變數方式，如同寫程式一般可以更靈活且彈性的進行部署及維護。 練習環境 可以使用 HowHow 的創建 Lab 練"/>
<meta name="application-name" content="HowHow の WebSite">
<meta name="apple-mobile-web-app-title" content="HowHow の WebSite"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.howhow.tk/posts/ansible/2022/ansible-variables/" /><link rel="prev" href="https://blog.howhow.tk/posts/ansible/2022/ansible-vault-encrypt/" /><link rel="next" href="https://blog.howhow.tk/posts/windows/2022/windows-2016-installer/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Ansible - 變數管理及應用",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.howhow.tk\/posts\/ansible\/2022\/ansible-variables\/"
        },"genre": "posts","keywords": "Ansible","wordcount":  1741 ,
        "url": "https:\/\/blog.howhow.tk\/posts\/ansible\/2022\/ansible-variables\/","datePublished": "2022-04-01T00:00:00+00:00","dateModified": "2022-04-01T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "HowHow"},"author": {
                "@type": "Person",
                "name": "HowHow"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="HowHow の WebSite"><span class="header-title-pre"><i class='fab fa-blogger'></i></span>HowHow</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/"> Home </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/redhat/"> Exam </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="HowHow の WebSite"><span class="header-title-pre"><i class='fab fa-blogger'></i></span>HowHow</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/" title="">Home</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/redhat/" title="">Exam</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Ansible - 變數管理及應用</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>HowHow</a></span>&nbsp;<span class="post-category">included in <a href="/categories/ansible/"><i class="far fa-folder fa-fw"></i>Ansible</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-04-01">2022-04-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1741 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;預計閱讀 4 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1ansible-變數介紹">1.Ansible 變數介紹</a></li>
    <li><a href="#2-playbook-定義變數">2. Playbook 定義變數</a>
      <ul>
        <li><a href="#21-定義變數於-playbook-內">2.1. 定義變數於 PlayBook 內</a></li>
        <li><a href="#22-定義變數檔案於-playbook-內">2.2. 定義變數檔案於 PlayBook 內</a></li>
      </ul>
    </li>
    <li><a href="#3-playbook-中使用變數">3. PlayBook 中使用變數</a></li>
    <li><a href="#4-主機變數及群組變數">4. 主機變數及群組變數</a></li>
    <li><a href="#5-使用資料夾管理主機變數及群組變數">5. 使用資料夾管理主機變數及群組變數</a>
      <ul>
        <li><a href="#51-group_vars-資料夾管理群組變數">5.1. group_vars 資料夾管理群組變數</a></li>
        <li><a href="#52-host_vars-資料夾管理主機變數">5.2. host_vars 資料夾管理主機變數</a></li>
      </ul>
    </li>
    <li><a href="#6-指令定義變數">6. 指令定義變數</a></li>
    <li><a href="#7-ansible-變數使用建議">7. Ansible 變數使用建議</a></li>
    <li><a href="#8-ansible-fact-變數">8. Ansible Fact 變數</a>
      <ul>
        <li><a href="#81-fact-變數取值">8.1. Fact 變數取值</a></li>
        <li><a href="#82-fact-變數取值應用">8.2. Fact 變數取值應用</a></li>
        <li><a href="#83-儲存-fact-變數內容小技巧">8.3. 儲存 Fact 變數內容小技巧</a></li>
        <li><a href="#84-停止自動採集-fact">8.4. 停止自動採集 Fact</a></li>
      </ul>
    </li>
    <li><a href="#9-ansible-魔法變數">9. Ansible 魔法變數</a></li>
    <li><a href="#10-小結">10. 小結</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>透過 Playbook 可以很方便執行大量機器部署，在大量環境下可以透過變數方式，如同寫程式一般可以更靈活且彈性的進行部署及維護。</p>
<!--  more -->
<div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw"></i>練習環境<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><em>可以使用 HowHow 的創建 Lab 練習環境，來操作多台機器練習 Ansible，<a href="https://how64bit.com/posts/linux/2022/linux-create-playground/" target="_blank" rel="noopener noreffer">使用方式請參閱 HowHow 網站</a>。</em></div>
        </div>
    </div>
<h2 id="1ansible-變數介紹">1.Ansible 變數介紹</h2>
<p>Ansible 可以使用變數使得執行起來更佳彈性且靈活，像是角色創立、套件安裝、服務啟動等等，另外 Ansible 變數取名方式與 Python 一致，使用蛇形命名法(snake case)，例如: web_server_01 。</p>
<hr>
<h2 id="2-playbook-定義變數">2. Playbook 定義變數</h2>
<h3 id="21-定義變數於-playbook-內">2.1. 定義變數於 PlayBook 內</h3>
<p>使用 vars 關鍵字並定義變數 ， Playbook 範例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">var example</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">joe</span><span class="w">
</span><span class="w">      </span><span class="nt">home</span><span class="p">:</span><span class="w"> </span><span class="l">/home/joe</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="22-定義變數檔案於-playbook-內">2.2. 定義變數檔案於 PlayBook 內</h3>
<p>使用 vars_files 關鍵字定義變數的檔案路徑 ， Playbook 範例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">var example</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">vars_files</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">users.yml</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>user.yml 變數檔案內容範例 :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">joe</span><span class="w">
</span><span class="w"></span><span class="nt">home</span><span class="p">:</span><span class="w"> </span><span class="l">/home/joe</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="3-playbook-中使用變數">3. PlayBook 中使用變數</h2>
<p>使用兩個大刮號包住變數名稱，即可使用定義好的變數，Playbook 範例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">var example</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">user </span><span class="p">:</span><span class="w"> </span><span class="l">joe</span><span class="w">
</span><span class="w">    
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Create the User  {{ user }}</span><span class="w">
</span><span class="w">      </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ user }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>IMPORTANT<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><em>變數如果為 Value 第一個開頭需要加註雙引號，如上 PlayBook 內容 ， 兩個不同的樣式。</em></div>
        </div>
    </div>
<h2 id="4-主機變數及群組變數">4. 主機變數及群組變數</h2>
<p>在 inventory 中也可以定義變數，不過此作法比較少用，影響 inventory 可讀性及維護性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">[servera]
demo1.example.com
demo2.example.com

[web]
demo2.example.com
demo3.exmaple.com

[servera:vars]
user=joe

[pd:children]
web
servera

[pd:vars]
user=administrator
</code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="5-使用資料夾管理主機變數及群組變數">5. 使用資料夾管理主機變數及群組變數</h2>
<p>透過 group_vars 及 host_vars 兩個資料夾管理群組及主機變數，此方式最常使用管理較為直覺也容易，其專案架構如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">[student@workstation example-project]$ tree -F
.
├── ansible.cfg
├── group_vars/
│   ├── datacenter1
│   ├── datacenter2
│   └── datacenters
├── host_vars/
│   ├── demo1.example.com
│   └── demo2.example.com
├── inventory
└── playbook.yml
</code></pre></td></tr></table>
</div>
</div><p>inventory 內容:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>student@workstation example-project<span class="o">]</span>$ cat inventory 
<span class="o">[</span>datacenter1<span class="o">]</span>
demo1.example.com
demo2.example.com

<span class="o">[</span>datacenter2<span class="o">]</span>
demo3.example.com
demo4.example.com

<span class="o">[</span>datecenters:children<span class="o">]</span>
datacenter1
datacenter2
</code></pre></td></tr></table>
</div>
</div><h3 id="51-group_vars-資料夾管理群組變數">5.1. group_vars 資料夾管理群組變數</h3>
<p>在 group_vars 資料夾內建立對應群組的檔案名稱，並在該檔案內定義變數。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>student@workstation example-project<span class="o">]</span>$ cat group_vars/datacenter1
service: httpd
<span class="o">[</span>student@workstation example-project<span class="o">]</span>$ cat group_vars/datacenter2
service: php
<span class="o">[</span>student@workstation example-project<span class="o">]</span>$ cat group_vars/datacenters
package: httpd
</code></pre></td></tr></table>
</div>
</div><h3 id="52-host_vars-資料夾管理主機變數">5.2. host_vars 資料夾管理主機變數</h3>
<p>在 host_vars 資料夾內建立對應主機的檔案名稱，並在該檔案內定義變數。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>student@workstation example-project<span class="o">]</span>$ cat host_vars/demo1.example.com 
packege: mysql-server
<span class="o">[</span>student@workstation example-project<span class="o">]</span>$ cat host_vars/demo2.example.com 
package: firewalld
</code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="6-指令定義變數">6. 指令定義變數</h2>
<p>透過 ansible-playbook 定義執行變數。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">ansible-playbook example.yml -e &#34;package=httpd&#34;
</code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="7-ansible-變數使用建議">7. Ansible 變數使用建議</h2>
<p>Ansible 可以設定變數的地方還有十分的多，可至 <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#understanding-variable-precedence" target="_blank" rel="noopener noreffer">Ansible 官方手冊</a> 查閱 ，建議在同一個公司內共同商議，要在哪個地方使用變數，方便管理及維護。</p>
<hr>
<h2 id="8-ansible-fact-變數">8. Ansible Fact 變數</h2>
<p>在 Ansible 執行時，第一個 task 任務總是會出現 Gathering Facts ，這個任務就是搜尋所有主機的相關訊息並存為 Fact 變數，這任務預設會自動採集，除非手動設置不採集。
Fact 會採集下列相關訊息( 僅列出部分 ):</p>
<ol>
<li>主機名稱</li>
<li>核心版本</li>
<li>網路介面卡</li>
<li>IP 地址</li>
<li>作業系統版本</li>
<li>環境變數</li>
<li>CPU</li>
<li>記憶體</li>
<li>硬碟空間</li>
</ol>
<p>透過 Fact 可以藉由不同機器做出不同條件篩選，例如大於多少空間硬碟才部署 MySQL 或是哪些 IP 執行特定操作等。</p>
<p>印出 Fact Playbook 範例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>student@workstation example<span class="o">]</span>$ cat fact.yml 
- name: Fact dump
  hosts: serverb
  tasks:
    - name: Print all facts
      debug:
        var: ansible_facts
</code></pre></td></tr></table>
</div>
</div><p>範例執行結果 ( ansible_facts 為 fact 的關鍵字) :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>student@workstation example<span class="o">]</span>$ ansible-playbook fact.yml 

PLAY <span class="o">[</span>Fact dump<span class="o">]</span> ***********************************************************************************************

TASK <span class="o">[</span>Gathering Facts<span class="o">]</span> *****************************************************************************************
ok: <span class="o">[</span>serverb<span class="o">]</span>

TASK <span class="o">[</span>Print all facts<span class="o">]</span> *****************************************************************************************
ok: <span class="o">[</span>serverb<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;all_ipv4_addresses&#34;</span>: <span class="o">[</span>
            <span class="s2">&#34;172.25.250.11&#34;</span>
        <span class="o">]</span>,
        <span class="s2">&#34;all_ipv6_addresses&#34;</span>: <span class="o">[]</span>,
        <span class="s2">&#34;ansible_local&#34;</span>: <span class="o">{}</span>,
        <span class="s2">&#34;apparmor&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;disabled&#34;</span>
        <span class="o">}</span>,
        <span class="s2">&#34;architecture&#34;</span>: <span class="s2">&#34;x86_64&#34;</span>,
        <span class="s2">&#34;bios_date&#34;</span>: <span class="s2">&#34;04/01/2014&#34;</span>,
        <span class="s2">&#34;bios_version&#34;</span>: <span class="s2">&#34;1.13.0-2.module+el8.4.0+534+4680a14e&#34;</span>,
        <span class="s2">&#34;cmdline&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;BOOT_IMAGE&#34;</span>: <span class="s2">&#34;(hd0,msdos1)/vmlinuz-4.18.0-348.el8.0.2.x86_64&#34;</span>,
            <span class="s2">&#34;rd.lvm.lv&#34;</span>: <span class="s2">&#34;rl_workstation/swap&#34;</span>,
            <span class="s2">&#34;resume&#34;</span>: <span class="s2">&#34;/dev/mapper/rl_workstation-swap&#34;</span>,
            <span class="s2">&#34;ro&#34;</span>: true,
            <span class="s2">&#34;root&#34;</span>: <span class="s2">&#34;/dev/mapper/rl_workstation-root&#34;</span>
        <span class="o">}</span>,
...
</code></pre></td></tr></table>
</div>
</div><h3 id="81-fact-變數取值">8.1. Fact 變數取值</h3>
<p>透過上述範例，可以知道 ansible_facts 變數內存放不同的內容，可以使用於 Python Dict 字典方式將 Value 取出。</p>
<table>
<thead>
<tr>
<th>Fact</th>
<th>變數</th>
</tr>
</thead>
<tbody>
<tr>
<td>Short host name</td>
<td><code>ansible_facts['hostname']</code></td>
</tr>
<tr>
<td>FQDN</td>
<td><code>ansible_facts['fqdn']</code></td>
</tr>
<tr>
<td>IPv4</td>
<td><code>ansible_facts['ansible_default_ipv4']['address']</code></td>
</tr>
<tr>
<td>顯示 DNS 列表</td>
<td><code>ansible_facts['dns']['nameservers']</code></td>
</tr>
<tr>
<td>顯示 /dev/vda1 分區大小</td>
<td><code>ansible_facts['devices']['vda']['partitions']['vda1']['size']</code></td>
</tr>
</tbody>
</table>
<div class="details admonition NOTE open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>NOTE<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p><em>除了使用中刮號取值之外也可以使用物件屬性方式取值～</em></p>
<blockquote>
<p><code>ansible_facts['ansible_default_ipv4']['address']</code> ，此方是可以取得 IPv4 。
<code>ansible_facts.ansible_default_ipv4.address</code> ， 此方式也可以取得 IPv4 。</p>
</blockquote>
</div>
        </div>
    </div>
<h3 id="82-fact-變數取值應用">8.2. Fact 變數取值應用</h3>
<p>印出受控主機 IPv4 地址， Playbook 範例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Example</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Print various Ansible facts</span><span class="w">
</span><span class="w">      </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="l">The default IPv4 address of {{ ansible_facts.fqdn }} is {{ ansible_facts.default_ipv4.address  }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Playbook 執行結果 :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>student@workstation example<span class="o">]</span>$ ansible-playbook example.yml 

PLAY <span class="o">[</span>Example<span class="o">]</span> ************************************************************************************************

TASK <span class="o">[</span>Gathering Facts<span class="o">]</span> ****************************************************************************************
ok: <span class="o">[</span>serverb<span class="o">]</span>
ok: <span class="o">[</span>servera<span class="o">]</span>
ok: <span class="o">[</span>serverc<span class="o">]</span>

TASK <span class="o">[</span>Print various Ansible facts<span class="o">]</span> ****************************************************************************
ok: <span class="o">[</span>servera<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;msg&#34;</span>: <span class="s2">&#34;The default IPv4 address of servera.lab.example.com is 172.25.250.10&#34;</span>
<span class="o">}</span>
ok: <span class="o">[</span>serverb<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;msg&#34;</span>: <span class="s2">&#34;The default IPv4 address of serverb.lab.example.com is 172.25.250.11&#34;</span>
<span class="o">}</span>
ok: <span class="o">[</span>serverc<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;msg&#34;</span>: <span class="s2">&#34;The default IPv4 address of serverc.lab.example.com is 172.25.250.12&#34;</span>
<span class="o">}</span>

PLAY RECAP ****************************************************************************************************
servera                    : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>    <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>   
serverb                    : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>    <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>   
serverc                    : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>    <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>   
</code></pre></td></tr></table>
</div>
</div><h3 id="83-儲存-fact-變數內容小技巧">8.3. 儲存 Fact 變數內容小技巧</h3>
<p>使用 ansible 的 setup 模組，可以採集 fact 再藉由 Linux 輸出導向至檔案內，就可以慢慢查看並找到所要的變數內容來應用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>student@workstation example<span class="o">]</span>$ ansible serverc -m setup &gt; /tmp/serverc.facts
<span class="o">[</span>student@workstation example<span class="o">]</span>$ head /tmp/serverc.facts 
serverc <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;ansible_all_ipv4_addresses&#34;</span>: <span class="o">[</span>
            <span class="s2">&#34;172.25.250.12&#34;</span>
        <span class="o">]</span>,
        <span class="s2">&#34;ansible_all_ipv6_addresses&#34;</span>: <span class="o">[]</span>,
        <span class="s2">&#34;ansible_apparmor&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;disabled&#34;</span>
        <span class="o">}</span>,
        <span class="s2">&#34;ansible_architecture&#34;</span>: <span class="s2">&#34;x86_64&#34;</span>,
</code></pre></td></tr></table>
</div>
</div><h3 id="84-停止自動採集-fact">8.4. 停止自動採集 Fact</h3>
<p>每一次採集 Fact 大約耗上 1 - 2 秒時間，少量機器執行不會有感覺，如果今天要部署上千台機器，且又不會使用到 Fact 變數，就可以手動關閉採集 ( gather_facts : no ) ，加速 Playbook 執行效率。</p>
<p>停用 facts 自動採集 Playbook 範例 :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="9-ansible-魔法變數">9. Ansible 魔法變數</h2>
<p>有些變數無法透過 setup 模組 ( Fact ) 採集，而是藉由 ansible 自動產生的變數稱做魔法變數，例如:</p>
<ol>
<li>group_names : 在 Inventory 主機清單內的群組名稱。</li>
<li>groups ：在 Inventory 主機清單內群組的主機清單。</li>
<li>playbook_dir : 執行 playbook 路徑</li>
</ol>
<p>更多魔法變數請至 <a href="https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html" target="_blank" rel="noopener noreffer">Ansible 官方手冊</a>查閱 。</p>
<hr>
<h2 id="10-小結">10. 小結</h2>
<p>Ansible 變數運用千變萬化， 能有效掌握變數更能寫出可讀性且彈性較高的 PlayBook 。</p>
</div><br>

<br>
<blockquote style="font-style: italic;border-left: 4px solid #ddd;color: var(--blockquote-color);margin: 0;padding: 0 15px;">
  <p>如果還沒有註冊 Like Coin，可以在下方看到拍手的按鈕，點下去後即可申請帳號，註冊後最多可以拍手五下，而且不用付出任何一塊錢，就能給這篇文章的最大的鼓勵！</p>
</blockquote>

<iframe
  class="LikeCoin"
  height="235"
  src="https://button.like.co/in/embed/wen9077/button?referrer=https%3a%2f%2fblog.howhow.tk%2fposts%2fansible%2f2022%2fansible-variables%2f"
  width="100%"
  frameborder="0"
></iframe>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P7XL29C3NC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P7XL29C3NC');
</script><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-04-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ansible/">Ansible</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/ansible/2022/ansible-vault-encrypt/" class="prev" rel="prev" title="Ansible - Vault 加密檔案管理"><i class="fas fa-angle-left fa-fw"></i>Ansible - Vault 加密檔案管理</a>
            <a href="/posts/windows/2022/windows-2016-installer/" class="next" rel="next" title="Windows - Win Server 2016 伺服器安裝及設定">Windows - Win Server 2016 伺服器安裝及設定<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><h3  style="font-style:italic;">你不一定要很厲害，才能開始；但你要開始，才能很厲害。</h3></div><div class="footer-line"></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://howhowwen.disqus.com/embed.js" defer></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":100},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
